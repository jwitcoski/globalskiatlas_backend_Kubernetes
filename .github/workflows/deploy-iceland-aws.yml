# Build ski atlas pipeline image, push to ECR, optionally run ECS task (any region).
# Task size by region: small (iceland), medium (south-america/africa), large (australia-oceania), xlarge (europe/north-america/asia).
# Requires: AWS_ACCESS_KEY_ID, AWS_SECRET_ACCESS_KEY, AWS_REGION, ECR_REPOSITORY,
#           ECS_CLUSTER, ECS_SUBNETS, ECS_SECURITY_GROUP, S3_BUCKET

name: Deploy pipeline to AWS

on:
  push:
    branches: [main]
  workflow_dispatch:
    inputs:
      run_task:
        description: 'Run ECS task after push'
        required: false
        default: false
        type: boolean
      region:
        description: 'Region to run (PBF extract)'
        required: true
        default: 'iceland'
        type: choice
        options:
          - iceland
          - north-america
          - south-america
          - europe
          - asia
          - africa
          - australia-oceania

env:
  AWS_REGION: ${{ secrets.AWS_REGION || 'us-east-1' }}

jobs:
  build-and-push:
    runs-on: ubuntu-latest
    permissions:
      id-token: write
      contents: read
    outputs:
      image: ${{ steps.build.outputs.image }}

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Configure AWS credentials
        uses: aws-actions/configure-aws-credentials@v4
        with:
          aws-access-key-id: ${{ secrets.AWS_ACCESS_KEY_ID }}
          aws-secret-access-key: ${{ secrets.AWS_SECRET_ACCESS_KEY }}
          aws-region: ${{ env.AWS_REGION }}

      - name: Login to Amazon ECR
        id: ecr
        uses: aws-actions/amazon-ecr-login@v2

      - name: Build and push image
        id: build
        env:
          ECR_REGISTRY: ${{ steps.ecr.outputs.registry }}
          ECR_REPOSITORY: ${{ secrets.ECR_REPOSITORY || 'globalskiatlas-backend-k8s-pipeline' }}
          IMAGE_TAG: ${{ github.sha }}
        run: |
          docker build -f Dockerfile.aws -t $ECR_REGISTRY/$ECR_REPOSITORY:$IMAGE_TAG -t $ECR_REGISTRY/$ECR_REPOSITORY:latest .
          docker push $ECR_REGISTRY/$ECR_REPOSITORY:$IMAGE_TAG
          docker push $ECR_REGISTRY/$ECR_REPOSITORY:latest
          echo "image=$ECR_REGISTRY/$ECR_REPOSITORY:$IMAGE_TAG" >> $GITHUB_OUTPUT

  run-ecs-task:
    needs: build-and-push
    if: github.event_name == 'workflow_dispatch' && inputs.run_task
    runs-on: ubuntu-latest
    permissions:
      id-token: write
      contents: read

    steps:
      - name: Configure AWS credentials
        uses: aws-actions/configure-aws-credentials@v4
        with:
          aws-access-key-id: ${{ secrets.AWS_ACCESS_KEY_ID }}
          aws-secret-access-key: ${{ secrets.AWS_SECRET_ACCESS_KEY }}
          aws-region: ${{ env.AWS_REGION }}

      - name: Run ECS task
        env:
          SUBNETS: ${{ secrets.ECS_SUBNETS }}
          SECURITY_GROUP: ${{ secrets.ECS_SECURITY_GROUP }}
          S3_BUCKET: ${{ secrets.S3_BUCKET }}
          ECS_CLUSTER: ${{ secrets.ECS_CLUSTER }}
          REGION_NAME: ${{ inputs.region }}
        run: |
          if [ -z "$SUBNETS" ] || [ -z "$SECURITY_GROUP" ]; then
            echo "::warning::ECS_SUBNETS and ECS_SECURITY_GROUP must be set to run the task"
            exit 0
          fi
          case "$REGION_NAME" in
            iceland) PBF_URL="https://download.geofabrik.de/europe/iceland-latest.osm.pbf"
                     TASK_DEFINITION="globalskiatlas-backend-k8s-pipeline-small"
                     OSM_CLUSTER_DIST="" ;;
            north-america|europe|asia) PBF_URL="https://download.geofabrik.de/${REGION_NAME}-latest.osm.pbf"
                     TASK_DEFINITION="globalskiatlas-backend-k8s-pipeline-xlarge"
                     OSM_CLUSTER_DIST="200000" ;;
            south-america) PBF_URL="https://download.geofabrik.de/south-america-latest.osm.pbf"
                     TASK_DEFINITION="globalskiatlas-backend-k8s-pipeline-medium"
                     OSM_CLUSTER_DIST="" ;;
            africa) PBF_URL="https://download.geofabrik.de/africa-latest.osm.pbf"
                     TASK_DEFINITION="globalskiatlas-backend-k8s-pipeline-medium"
                     OSM_CLUSTER_DIST="" ;;
            australia-oceania) PBF_URL="https://download.geofabrik.de/australia-oceania-latest.osm.pbf"
                     TASK_DEFINITION="globalskiatlas-backend-k8s-pipeline-large"
                     OSM_CLUSTER_DIST="" ;;
            *) PBF_URL="https://download.geofabrik.de/europe/iceland-latest.osm.pbf"
               TASK_DEFINITION="globalskiatlas-backend-k8s-pipeline-small"
               OSM_CLUSTER_DIST="" ;;
          esac
          echo "Region: $REGION_NAME | PBF: $PBF_URL | Task: $TASK_DEFINITION"
          # Build network config JSON (subnets: "a,b" -> ["a","b"])
          SUBNET_ARR=$(echo "$SUBNETS" | jq -R 'split(",") | map(gsub("^\\s+|\\s+$";""))')
          NETWORK_CONFIG=$(jq -n --argjson subnets "$SUBNET_ARR" --arg sg "$SECURITY_GROUP" \
            '{awsvpcConfiguration: {subnets: $subnets, securityGroups: [$sg], assignPublicIp: "ENABLED"}}')
          # Build overrides JSON with jq (REGION + PBF_URL + OSM_NEARBY_CLUSTER_DIST_M for EU/NA)
          if [ -n "$OSM_CLUSTER_DIST" ]; then
            OVERRIDES=$(jq -n \
              --arg s3 "$S3_BUCKET" \
              --arg region "$REGION_NAME" \
              --arg aws_region "${{ env.AWS_REGION }}" \
              --arg pbf_url "$PBF_URL" \
              --arg cluster_dist "$OSM_CLUSTER_DIST" \
              '{containerOverrides: [{name: "pipeline", environment: [{name: "S3_BUCKET", value: $s3}, {name: "REGION", value: $region}, {name: "AWS_REGION", value: $aws_region}, {name: "PBF_URL", value: $pbf_url}, {name: "OSM_NEARBY_CLUSTER_DIST_M", value: $cluster_dist}]}]}')
          else
            OVERRIDES=$(jq -n \
              --arg s3 "$S3_BUCKET" \
              --arg region "$REGION_NAME" \
              --arg aws_region "${{ env.AWS_REGION }}" \
              --arg pbf_url "$PBF_URL" \
              '{containerOverrides: [{name: "pipeline", environment: [{name: "S3_BUCKET", value: $s3}, {name: "REGION", value: $region}, {name: "AWS_REGION", value: $aws_region}, {name: "PBF_URL", value: $pbf_url}]}]}')
          fi
          TASK_ARN=$(aws ecs run-task \
            --cluster "$ECS_CLUSTER" \
            --task-definition "$TASK_DEFINITION" \
            --launch-type FARGATE \
            --network-configuration "$NETWORK_CONFIG" \
            --overrides "$OVERRIDES" \
            --query 'tasks[0].taskArn' --output text)
          echo "Task started: $TASK_ARN"
          echo "task_arn=$TASK_ARN" >> $GITHUB_OUTPUT
