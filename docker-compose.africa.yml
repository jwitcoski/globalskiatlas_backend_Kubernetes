# Africa flow: Download → Extract (osmium) → OSM nearby (local PBF) → Parquet
# Uses Geofabrik Africa PBF (~3–4 GB). Tests clustering (5 ski areas across Morocco, Lesotho, etc.).
# Usage: docker compose -f docker-compose.africa.yml up --build

volumes:
  ski-data-africa:

services:
  download:
    image: alpine:latest
    container_name: africa-download
    user: root
    volumes:
      - ski-data-africa:/db
    command: >
      sh -c "apk add --no-cache wget
      && wget --progress=bar:force -O /db/planet.osm.pbf https://download.geofabrik.de/africa-latest.osm.pbf
      && echo Download complete"

  extract:
    image: iceland-extract
    build:
      context: .
      dockerfile: Dockerfile.extract
    container_name: africa-extract
    depends_on:
      download:
        condition: service_completed_successfully
    volumes:
      - ski-data-africa:/db
      - ./output/africa:/data
    command: ["python", "scripts/pbf_to_geojson.py", "/db/planet.osm.pbf", "/data/ski_areas.geojson"]

  osm_nearby:
    image: iceland-extract
    container_name: africa-osm-nearby
    depends_on:
      extract:
        condition: service_completed_successfully
    environment:
      - PYTHONUNBUFFERED=1
    volumes:
      - ski-data-africa:/db
      - ./output/africa:/data
    working_dir: /app
    command: ["python", "scripts/extract_nearby_from_pbf.py", "/db/planet.osm.pbf", "/data/ski_areas.geojson", "-o", "/data/osm_near_winter_sports.json"]

  lifts_and_pistes:
    image: iceland-extract
    container_name: africa-lifts-pistes
    depends_on:
      extract:
        condition: service_completed_successfully
    volumes:
      - ski-data-africa:/db
      - ./output/africa:/data
    working_dir: /app
    command: ["python", "scripts/extract_lifts_and_pistes_from_pbf.py", "/db/planet.osm.pbf", "-o", "/data"]

  enrich_geojson:
    build:
      context: .
      dockerfile: Dockerfile
    container_name: africa-enrich-geojson
    depends_on:
      extract:
        condition: service_completed_successfully
      lifts_and_pistes:
        condition: service_completed_successfully
      osm_nearby:
        condition: service_completed_successfully
    environment:
      - PYTHONUNBUFFERED=1
    volumes:
      - ./output/africa:/data
      - ./boundaries:/boundaries
    working_dir: /app
    command: ["python", "scripts/enrich_geojson_properties.py", "all", "-d", "/data", "-b", "/boundaries"]

  analyze:
    build:
      context: .
      dockerfile: Dockerfile
    container_name: africa-analyze
    depends_on:
      osm_nearby:
        condition: service_completed_successfully
    volumes:
      - ./output/africa:/data
      - ./boundaries:/boundaries
    working_dir: /app
    command: ["python", "analyze_ski_areas.py", "/data/ski_areas.geojson", "/data/osm_near_winter_sports.json", "-o", "/data/ski_areas_analyzed.csv", "-b", "/boundaries"]

  export_parquet:
    build:
      context: .
      dockerfile: Dockerfile
    container_name: africa-export-parquet
    depends_on:
      enrich_geojson:
        condition: service_completed_successfully
      analyze:
        condition: service_completed_successfully
    volumes:
      - ./output/africa:/data
    working_dir: /app
    command: >
      sh -c "python convert_to_geoparquet.py osm -i /data/osm_near_winter_sports.json -o /data/osm_near_winter_sports.parquet
      && python convert_to_geoparquet.py all -d /data
      && rm -f /data/lifts.geojson /data/osm_near_winter_sports.json /data/pistes.geojson /data/ski_areas.geojson
      && echo 'Removed GeoJSON/JSON to save space (keeping parquet and ski_areas_analyzed.csv)'"
